\documentclass[
  a4paper,
  11pt,
]{memoir}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Layout

%% For temporary redefining the geometry of titlepage, bibliography, and
%% backcover.  Have to include here, otherwise it resets the Memoir layout.
\usepackage{geometry}

%% Stock size is same as page (A4).
\settrims{0pt}{0pt}

%% Line length set in Charter for 65 chars is ~26.5pc.  We go as low as possible
%% to give room to the margins.  Height is as large as possible (we don't use
%% the footer).
\settypeblocksize{627pt}{26pc}{*}

%% 2cm spine is enough (we need space here!).
\setlrmargins{2cm}{*}{*}

%% Don't have an opinion on header yet.  Just not too near to body text.
%% \setheadfoot{\baselineskip}{0pt}
\setheaderspaces{*}{4pc}{*}

%% Yeah margin notes!
\setmarginnotes{2pc}{15pc}{1pc}

\checkandfixthelayout

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% General typography

%% TTF fonts with XeLaTeX.
\usepackage{fontspec}

%% Charter is an amazing body font.
\setromanfont{Charter}

%% Fira Sans is nice for the titles.
\setsansfont[
  BoldFont=FiraSans-Medium,
  ItalicFont=FiraSans-BookItalic,
  BoldItalicFont=FiraSans-MediumItalic,
  Scale=MatchUppercase
]{Fira Sans Book}

%% A monospace font that handles utf8 chars.  And is not too wide.
%% Scaled to match the body font.
\setmonofont[Scale=MatchUppercase]{Source Code Pro}

%% French typographical conventions and translated names for “Chapitre”, “Table
%% des matières”, etc.
\usepackage[french]{babel}

%% Move characters around and minimize hyphenation.  Good for diversity.  Not as
%% powerful with XeLaTeX, as font information may be missing.
\usepackage{microtype}


%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Headings

%% Sans-serif headings
\headstyles{komalike}

%% In-your-face chapter style
\chapterstyle{pedersen}
\renewcommand{\chaptitlefont}{\Huge\sffamily}
\renewcommand{\chapnumfont}{\sffamily\itshape}

%% Headers run into the margin
\setlength{\headwidth}{\textwidth}
\addtolength{\headwidth}{\marginparsep}
\addtolength{\headwidth}{\marginparwidth}
\makerunningwidth{headings}{\headwidth}
\makeheadposition{headings}{flushright}{flushleft}{}{}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Side notes (in the outer margin)

%% For hyphenation in ragged text, which gives more even side notes.
\usepackage{ragged2e}

%% Margin notes using marginpar
\setmpjustification{\RaggedLeft}{\RaggedRight}

\marginparmargin{outer}         % for \mpjustification
\let\oldmarginpar\marginpar
\renewcommand\marginpar[2][]{%
  \oldmarginpar{\small\mpjustification #2}}

%% To refer to the body text of an environment.
\usepackage{environ}

%% Aside is for side commentary.  Like footnotes, but in the margin.
\NewEnviron{aside}[1][0pt]{\marginpar{\BODY}}

%% Side figures are an image and a caption, both in the margin.
\NewEnviron{side-figure}[1][0pt]{\marginpar{\BODY}}

%% Babel french puts it in small caps.  I don’t want that.
%% Additionally, override figurename for listings.
%% HACK: maybe using a new environment for the listings would be a better
%% solution.
%% \newcommand{\UnsetListingFigureName}{\renewcaptionname{french}{\figurename}{Figure}}
%% \UnsetListingFigureName
%% \newcommand{\SetListingFigureName}{\renewcaptionname{french}{\figurename}{Code}}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Epigraphs

\NewEnviron{epig}{\epigraph{\BODY}{}}
\setlength{\epigraphwidth}{20pc}
\setlength{\epigraphrule}{0pt}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Source code listings

%% Environment for source code snippets.
\usepackage{listings}
\lstset{
  basicstyle=\ttfamily\small,
  commentstyle=\ttfamily,
  columns=fullflexible, keepspaces=true,
  breaklines=false, showstringspaces=false,
  escapeinside={//*}{\^^M},     % Escape to LaTeX between //* and line return
  %% aboveskip=-4pt,               % No space above and below, symmetric
  %% belowskip=0pt,
  %extendedchars=true, inputencoding=utf8,
}

%% Org export produces environment for ‘js’, so we must define that language for
%% listings.
\lstdefinelanguage{js}{
  language={Java},
  morekeywords={with,var,function},
  deletekeywords={double},
}


%% Accept the following’ as languages, no special treatment.
\lstdefinelanguage{diff}{}
\lstdefinelanguage{smalltalk}{}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Bibliography

%% Quells a warning from biblatex with babel activated.  Not sure /what/ it does
%% though.
\usepackage{csquotes}

%% Generates the bibliography.  Handles UTF8-encoded bib files.
\usepackage[
  backend=biber,
  firstinits=false,
  sorting=nyt,                  % Sort by name, year, title
  backref=true,
  style=alphabetic,
  maxbibnames=10
]{biblatex}
\addbibresource{refs.bib}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Others

%% Needed for the \text command in math-mode.
\usepackage{amsmath}

%% A touch of color
\usepackage{xcolor}
\definecolor{rubric}{rgb}{0.65,0.12,0.09}
\definecolor{azure}{rgb}{0.06,0.3,0.5}

%% Diagram colors
\definecolor{c0}{HTML}{556270}
\definecolor{c1}{HTML}{4ECDC4}
\definecolor{c2}{HTML}{FF6B6B}
\definecolor{c3}{HTML}{C7F464}

%% For color legend in diagrams
\newcommand{\colorrule}[1]{\textcolor{#1}{\rule{8pt}{4pt}}}

%% Hyperlinks for citations and external links.
\usepackage{hyperref}
\hypersetup{
  unicode,                      % Always a good idea?
  colorlinks=true,              % Color links rather than put boxes around them
  linkcolor=rubric,             % internal link
  citecolor=rubric,             % bibliography link
  urlcolor=azure,               % external link
}


%% Temporary handling of special blocks.
%% \newenvironment{epigraph}{}{}
\newenvironment{full-figure}{}{}
