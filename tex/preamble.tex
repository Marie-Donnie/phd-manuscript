\documentclass{scrbook}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Layout

\KOMAoptions{
  paper=A4,
  BCOR=0mm,
  pagesize,
  mpinclude=true,               % Treat margin as part of text body
  fontsize=11pt,
}

%% Recompute layout based on the options above.  Without it, the layout is
%% pretty bad and there are a bunch of warnings in the output.
\recalctypearea

%% More space for margin notes.
\setlength{\marginparwidth}{3\marginparwidth}

%% More space for main text body.
\addtolength{\textheight}{5em}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% General typography

%% Computer modern fonts with extended support for European characters.
\usepackage{lmodern}

%% TTF fonts with XeLaTeX.
\usepackage{fontspec}

%% A monospace font that handles utf8 chars.  And is not too wide.
\setmonofont{Ubuntu Mono}

%% French typographical conventions and translated names for “Chapitre”, “Table
%% des matières”, etc.
\usepackage[french]{babel}

%% Move characters around and minimize hyphenation.  Good for diversity.
\usepackage{microtype}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Margin notes

%% Font to use for margin notes.
\newkomafont{margin}{\footnotesize}

%% For hyphenation in ragged text, which gives more even margin notes.
\usepackage{ragged2e}

%% Custom commands for margin notes with a counter and ragged text side
%% following odd and even pages.
\newcounter{marginnotecounter}
\newcommand{\marginnotemark}{\textsuperscript{\themarginnotecounter}}
\newcommand{\marginnote}[1]{%
  \marginpar[\RaggedLeft\usekomafont{margin}{\marginnotemark#1\par}]%
            {\RaggedRight\usekomafont{margin}{\marginnotemark#1\par}}}

%% Replace all footnotes with a marginnote.
\renewcommand{\footnote}{\refstepcounter{marginnotecounter}\marginnotemark\marginnote}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Source code listings

%% Environment for source code snippets.
\usepackage{listings}
\lstset{
  basicstyle=\ttfamily\small,
  commentstyle=\ttfamily,
  columns=fullflexible, keepspaces=true,
  breaklines=false, showstringspaces=false,
  escapeinside={//*}{\^^M},     % Escape to LaTeX between //* and line return
  captionpos=b,
  %extendedchars=true, inputencoding=utf8,
}

%% Org export produces environment for ‘js’, so we must define that language for
%% listings.
\lstdefinelanguage{js}{
  language={Java},
  morekeywords={with,var,function},
  deletekeywords={double},
}

%% Accept ‘diff’ as language, no special treatment.
\lstdefinelanguage{diff}{}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Bibliography

%% Quells a warning from biblatex with babel activated.  Not sure /what/ it does
%% though.
\usepackage{csquotes}

%% Generates the bibliography.  Handles UTF8-encoded bib files.
\usepackage[
  backend=biber,
  firstinits=false,
  sorting=nyt,                  % Sort by name, year, title
  backref=true,
  style=alphabetic,
  maxbibnames=10
]{biblatex}
\addbibresource{../refs.bib}

%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%% Others

%% A touch of color
\usepackage{xcolor}
\definecolor{rubric}{rgb}{0.65,0.12,0.09}
\definecolor{azure}{rgb}{0.06,0.3,0.5}

%% Hyperlinks for citations and external links.
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  linkcolor=rubric,             % internal link
  citecolor=rubric,             % bibliography link
  urlcolor=azure,               % external link
}
